<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hope's Corner - Shower & Supplies game</title>
    <link rel="icon" type="image/png"
        href="https://images.squarespace-cdn.com/content/5622cd82e4b0501d40689558/2aedb400-89b8-4f93-856f-cd2c7d5385e4/Hopes_Corner_Logo_Green.png?format=1500w&content-type=image%2Fpng">
    <meta name="description"
        content="Help Hope's Corner provide warm showers and essential supplies to the community through a dynamic sorting adventure.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="styles.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CP5WLN65B2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-CP5WLN65B2');
    </script>
</head>

<body>
    <div class="game-wrapper">
        <header class="header">
            <div class="flex items-center gap-2 md:gap-3">
                <img src="https://images.squarespace-cdn.com/content/5622cd82e4b0501d40689558/2aedb400-89b8-4f93-856f-cd2c7d5385e4/Hopes_Corner_Logo_Green.png?format=1500w&content-type=image%2Fpng"
                    alt="Hope's Corner Logo" class="h-10 md:h-12">
                <h1 class="text-lg md:text-2xl font-bold" style="color: var(--primary-dark);">Shower & Supplies</h1>
            </div>
            <div class="text-center flex-grow order-3 w-full lg:order-2 lg:w-auto">
                <h2 class="text-sm md:text-base font-semibold" style="color: var(--primary-dark);">Daily Update</h2>
                <p id="daily-event-text"
                    class="text-xs md:text-sm italic min-h-[40px] flex items-center justify-center px-2"></p>
            </div>
            <div class="flex items-center justify-center flex-wrap gap-x-3 md:gap-x-4 gap-y-2 order-2 lg:order-3">
                <div class="text-center"><span class="text-xs md:text-sm" style="color: var(--text-light);">Score</span>
                    <p id="score" class="text-base md:text-xl font-semibold" style="color: var(--primary);">0</p>
                </div>
                <div class="text-center"><span class="text-xs md:text-sm" style="color: var(--text-light);">Day</span>
                    <p id="day" class="text-base md:text-xl font-semibold" style="color: var(--text-main);">1</p>
                </div>
                <div class="w-20 md:w-32 text-center"><span class="text-xs md:text-sm"
                        style="color: var(--text-light);">Stress</span>
                    <div class="progress-bar h-2 mt-1">
                        <div id="stress-bar" class="progress-bar-fill bg-red-500" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="text-center"><span class="text-xs md:text-sm" style="color: var(--text-light);">Upset</span>
                    <p id="upset-guests-display" class="text-base md:text-xl font-semibold text-red-600">0 / 5</p>
                </div>
                <button id="volunteer-callout-btn" class="btn-volunteer">Call Volunteers (50pts)</button>
                <button id="leaderboard-btn" class="btn-primary ml-2">Leaderboard</button>
            </div>
        </header>

        <div id="game-container" class="game-container">
            <div id="guest-station" class="station">
                <div class="station-header"><span class="station-icon">üëã</span>
                    <h2 class="text-lg font-semibold">Guest Area</h2>
                </div>
                <h3 class="font-semibold text-center mb-2 text-gray-600">Waiting for Shower</h3>
                <div id="guest-queue" class="space-y-2 mb-4"></div>
                <h3 class="font-semibold text-center mb-2 text-gray-600">Waiting for Items</h3>
                <div id="requests-area" class="space-y-2 flex-grow"></div>
            </div>

            <div id="shower-station" class="station">
                <div class="station-header"><span class="station-icon">üöø</span>
                    <h2 class="text-lg font-semibold">Shower Stalls</h2>
                </div>
                <div id="shower-stalls-area" class="grid grid-cols-2 gap-4 flex-grow"></div>
            </div>

            <div id="supply-station" class="station">
                <div class="station-header"><span class="station-icon">üì¶</span>
                    <h2 class="text-lg font-semibold">Supplies</h2>
                </div>
                <button id="accept-supply-drop" class="btn-primary w-full mb-2 flex-shrink-0">Accept Donations</button>
                <p class="text-xs text-center text-gray-500 mb-2">Drag items from here to the bins below</p>
                <div id="supply-drop-area" class="mb-4 flex-shrink-0"></div>
                <div id="supply-bins" class="supply-bins-grid"></div>
            </div>

            <div id="laundry-station" class="station">
                <div class="station-header"><span class="station-icon">üß∫</span>
                    <h2 class="text-lg font-semibold">Laundry Station</h2>
                </div>
                <div id="laundry-machines-area" class="laundry-machines-grid"></div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden">
        <div id="start-modal" class="modal">
            <h1 class="text-2xl font-bold mb-2" style="color: var(--primary-dark);">Welcome to Shower & Supplies</h1>
            <p class="text-gray-700 mb-4 text-base">Join Hope's Corner in providing warm showers, laundry, and essential supplies to our community. Each day brings new challenges‚Äîyour care and quick thinking will make a difference!</p>
            <div class="text-left bg-blue-50 p-3 rounded-lg border border-blue-200 my-4">
                <h2 class="font-bold text-lg text-blue-800 mb-2">How to Play</h2>
                <ul class="list-disc pl-5 space-y-2 text-sm">
                    <li><b>On Mobile:</b> <b class="text-blue-600">Tap a guest</b> to select them, then <b class="text-green-600">tap an available shower or laundry machine</b> to assign them.</li>
                    <li><b>On Desktop:</b> You can also <b class="text-green-600">drag waiting guests</b> (üòä) to an available shower or laundry machine.</li>
                    <li>Click <b class="text-blue-600">"Accept Donations"</b> then drag supplies to the correct bins.</li>
                    <li><b class="text-red-600">Click dirty showers</b> (üßπ) to clean them.</li>
                    <li>After showering or laundry, guests will ask for items. <b class="text-purple-600">Click the item's icon</b> on their request to give it.</li>
                    <li>Serve guests before they become upset (üò†)! Watch the <b class="text-yellow-600">Daily Update</b> for new challenges.</li>
                    <li><b class="text-orange-600">Call Volunteers</b> (50 points) when overwhelmed‚Äîthey'll help with <b>showers, laundry, and supplies</b>!</li>
                </ul>
            </div>
            <button id="start-game-btn" class="btn-primary w-full">Begin Your Day</button>
        </div>
        <div id="game-over-modal" class="modal hidden">
            <h1 class="text-3xl font-bold mb-2 text-red-700">Day Over!</h1>
            <p id="game-over-reason" class="text-lg mb-4"></p>
            <p class="text-lg">Final Score: <span id="final-score" class="font-bold text-2xl"
                    style="color: var(--primary);">0</span></p>
            <button id="restart-game-btn" class="btn-primary w-full mt-4">Play Again</button>
        </div>
        <div id="leaderboard-modal" class="modal hidden">
            <h1 class="text-2xl font-bold mb-2" style="color: var(--primary-dark);">Leaderboard</h1>
            <div id="leaderboard-table-container" class="mb-4 min-h-[120px] flex flex-col items-center justify-center">
            </div>
            <button id="close-leaderboard-btn" class="btn-primary w-full mt-2">Close</button>
            <button id="play-again-btn" class="btn-primary w-full mt-2 hidden">Play Again</button>
        </div>
    </div>

    <div id="volunteer-notification" class="volunteer-notification hidden">
        <div class="volunteer-notification-content">
            <div class="volunteer-animation">üôã‚Äç‚ôÄÔ∏èüôã‚Äç‚ôÇÔ∏è</div>
            <h3>Volunteers Arrive!</h3>
            <p>Community helpers are pitching in to clean and organize!</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const DOMElements = {
                score: document.getElementById('score'), day: document.getElementById('day'),
                stressBar: document.getElementById('stress-bar'), upsetGuests: document.getElementById('upset-guests-display'),
                guestQueue: document.getElementById('guest-queue'), showerStallsArea: document.getElementById('shower-stalls-area'),
                requestsArea: document.getElementById('requests-area'), dailyEventText: document.getElementById('daily-event-text'),
                modalOverlay: document.getElementById('modal-overlay'), startModal: document.getElementById('start-modal'),
                gameOverModal: document.getElementById('game-over-modal'), finalScore: document.getElementById('final-score'),
                gameOverReason: document.getElementById('game-over-reason'), startGameBtn: document.getElementById('start-game-btn'),
                restartGameBtn: document.getElementById('restart-game-btn'), acceptSupplyDropBtn: document.getElementById('accept-supply-drop'),
                supplyDropArea: document.getElementById('supply-drop-area'), supplyBins: document.getElementById('supply-bins'),
                gameContainer: document.getElementById('game-container'),
                volunteerCalloutBtn: document.getElementById('volunteer-callout-btn'),
                volunteerNotification: document.getElementById('volunteer-notification')
            };

            const leaderboardUrl = 'https://script.google.com/macros/s/AKfycbzkQztKIezgMgpjqRBAyFstUFmkctO_cV2KYpulTEw-vCM3C_OgBqp0OBmMvbALkrln/exec';
            const leaderboardBtn = document.getElementById('leaderboard-btn');
            const leaderboardModal = document.getElementById('leaderboard-modal');
            const leaderboardTableContainer = document.getElementById('leaderboard-table-container');
            const closeLeaderboardBtn = document.getElementById('close-leaderboard-btn');
            const playAgainBtn = document.getElementById('play-again-btn');

            let gameState = {};
            const CONFIG = {
                MAX_STRESS: 100, MAX_UPSET_GUESTS: 5, NUM_SHOWER_STALLS: 2, NUM_LAUNDRY_MACHINES: 2, BASE_SHOWER_TIME: 10000,
                BASE_CLEAN_TIME: 6000, BASE_GUEST_PATIENCE: 30000, POINTS_PER_SHOWER: 50,
                POINTS_PER_ITEM: 25, SUPPLY_DROP_SIZE: 4, BASE_GUEST_ARRIVAL_MIN: 2500, BASE_GUEST_ARRIVAL_MAX: 3500,
                BASE_TWO_ITEM_CHANCE: 0.2, VOLUNTEER_COST: 50, VOLUNTEER_DURATION: 8000,
                BASE_WASH_TIME: 8000, BASE_DRY_TIME: 7000
            };
            const ITEM_TYPES = {
                shirts: { emoji: 'üëï', name: 'Shirt' },
                pants: { emoji: 'üëñ', name: 'Pants' },
                jackets: { emoji: 'üß•', name: 'Jacket' },
                toothbrush: { emoji: 'ü™•', name: 'Toothbrush' },
                shoes: { emoji: 'üëü', name: 'Shoes' },
                razor: { emoji: 'ü™í', name: 'Razor' },
                sleepingBags: { emoji: 'üõå', name: 'Sleeping Bag' },
                laundry: { emoji: 'üß∫', name: 'Laundry' }
            };
            const DAILY_EVENTS = [
                { id: "calm_day", text: "A calm, quiet day. Business as usual.", effect: {} },
                { id: "rainy_day", text: "üåßÔ∏è Rainy day rush! Guests arrive faster.", effect: { guestArrivalSpeed: 1.5 } },
                { id: "volunteer_help", text: "‚ú® Extra volunteers are helping clean today! Cleaning is much faster.", effect: { cleaningSpeed: 2 } },
                { id: "slow_heater", text: "üîß The water heater is slow today. Showers take longer.", effect: { showerSpeed: 0.7 } },
                { id: "jacket_demand", text: "üß• A cold front is moving in! Extra points for giving jackets.", effect: { itemBonus: { type: 'jackets', points: 30 } } },
                { id: "supply_shortage", text: "üöö A delivery is delayed. No new sleeping bag drops today.", effect: { supplyShortage: 'sleepingBags' } },
                { id: "impatient_crowd", text: "üò† It's a hot day and guests are impatient.", effect: { guestPatience: 0.75 } }
            ];

            function getDifficultySettings() {
                const difficultyTier = Math.floor(gameState.servicedGuestsCount / 7);
                const patienceMultiplier = Math.max(0.5, 1 - difficultyTier * 0.07);
                const timeMultiplier = 1 + difficultyTier * 0.06;
                const arrivalMultiplier = Math.max(0.3, 1 - difficultyTier * 0.07);
                const twoItemChance = Math.min(0.8, CONFIG.BASE_TWO_ITEM_CHANCE + difficultyTier * 0.08);

                return {
                    guestPatience: CONFIG.BASE_GUEST_PATIENCE * patienceMultiplier,
                    showerTime: CONFIG.BASE_SHOWER_TIME * timeMultiplier,
                    cleanTime: CONFIG.BASE_CLEAN_TIME * timeMultiplier,
                    guestArrivalMin: CONFIG.BASE_GUEST_ARRIVAL_MIN * 1.5 * arrivalMultiplier,
                    guestArrivalMax: CONFIG.BASE_GUEST_ARRIVAL_MAX * 1.5 * arrivalMultiplier,
                    twoItemChance: twoItemChance
                };
            }

            function showGuestTapHint() {
                if (localStorage.getItem('guestTapHintShown')) return;
                const firstGuest = DOMElements.guestQueue.querySelector('.guest');
                if (!firstGuest) return;
                let hint = document.createElement('div');
                hint.className = 'guest-tap-hint';
                hint.textContent = 'Tap to select!';
                firstGuest.style.position = 'relative';
                firstGuest.appendChild(hint);
                setTimeout(() => {
                    hint.remove();
                    localStorage.setItem('guestTapHintShown', '1');
                }, 2500);
            }

            function fetchLeaderboard() {
                leaderboardTableContainer.innerHTML = '<span class="text-gray-500">Loading...</span>';
                fetch(leaderboardUrl + '?action=get')
                    .then(res => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .then(result => {
                        if (!result.success || !Array.isArray(result.data)) {
                            leaderboardTableContainer.innerHTML = `<span class="text-red-500">Failed to load leaderboard. The data format is incorrect.</span>`;
                            return;
                        }
                        const top5 = result.data.slice(0, 5);
                        let table = `<table class='w-full text-left'><thead><tr><th class='pr-4'>Name</th><th>Score</th></tr></thead><tbody>`;
                        if (top5.length === 0) {
                            table += `<tr><td colspan="2" class="text-center py-4">No scores yet!</td></tr>`;
                        } else {
                            top5.forEach(row => {
                                const playerName = String(row.playerName || 'N/A').replace(/[<>]/g, c => ({ '<': '&lt;', '>': '&gt;' }[c]));
                                const score = parseInt(row.score) || 0;
                                table += `<tr><td class='pr-4'>${playerName}</td><td>${score}</td></tr>`;
                            });
                        }
                        table += '</tbody></table>';
                        leaderboardTableContainer.innerHTML = table;
                    })
                    .catch(() => {
                        leaderboardTableContainer.innerHTML = '<span class="text-red-500">Failed to load leaderboard.<br>This may be due to a network error or the backend script not being deployed for public access (CORS issue).</span>';
                    });
            }

            function promptAndSubmitScore(score) {
                DOMElements.modalOverlay.classList.remove('hidden');

                let name = prompt('Enter your name for the leaderboard (max 20 chars):', '');
                if (!name) {
                    DOMElements.gameOverModal.classList.remove('hidden');
                    leaderboardModal.classList.add('hidden');
                    return;
                }
                name = name.trim().slice(0, 20) || 'Anonymous';

                DOMElements.gameOverModal.classList.add('hidden');
                DOMElements.startModal.classList.add('hidden');
                leaderboardModal.classList.remove('hidden');
                playAgainBtn.classList.remove('hidden');
                leaderboardTableContainer.innerHTML = '<span class="text-gray-500">Submitting score...</span>';

                fetch(leaderboardUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'submit',
                        playerName: name,
                        score: score
                    }),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            setTimeout(fetchLeaderboard, 200);
                        } else {
                            throw new Error(data.error || 'Unknown submission error');
                        }
                    })
                    .catch(error => {
                        leaderboardTableContainer.innerHTML = `<span class="text-red-500">Failed to submit score: ${error.message}</span>`;
                    });
            }

            leaderboardBtn.addEventListener('click', () => {
                DOMElements.startModal.classList.add('hidden');
                DOMElements.gameOverModal.classList.add('hidden');
                leaderboardModal.classList.remove('hidden');
                playAgainBtn.classList.add('hidden');
                DOMElements.modalOverlay.classList.remove('hidden');
                fetchLeaderboard();
            });

            closeLeaderboardBtn.addEventListener('click', () => {
                leaderboardModal.classList.add('hidden');
                if (!DOMElements.gameOverModal.classList.contains('hidden')) {
                } else {
                    DOMElements.modalOverlay.classList.add('hidden');
                }
            });

            playAgainBtn.addEventListener('click', () => {
                leaderboardModal.classList.add('hidden');
                DOMElements.modalOverlay.classList.add('hidden');
                startGame();
            });

            function initializeGameState() {
                gameState = {
                    score: 0, day: 1, stress: 0, upsetGuests: 0, gameRunning: false,
                    nextIds: { guest: 0, supply: 0 },
                    guests: [], showers: [], laundryMachines: [], suppliesToSort: [],
                    inventory: { shirts: 2, pants: 2, jackets: 1, toothbrush: 2, shoes: 2, razor: 1, sleepingBags: 1, laundry: 0 },
                    currentEvent: {},
                    timers: { gameLoop: null, guestSpawner: null, patience: [] },
                    dragged: { type: null, id: null, element: null },
                    servicedGuestsCount: 0,
                    selectedGuestId: null,
                    volunteersActive: false,
                    volunteerEndTime: null
                };
                for (let i = 0; i < CONFIG.NUM_SHOWER_STALLS; i++) {
                    gameState.showers.push({ id: `shower-${i}`, status: 'available', timer: null, progress: 0 });
                }
                for (let i = 0; i < CONFIG.NUM_LAUNDRY_MACHINES; i++) {
                    gameState.laundryMachines.push({ id: `laundry-${i}`, status: 'available', timer: null, progress: 0, guestId: null });
                }
            }

            function selectGuest(guestId) {
                if (gameState.selectedGuestId === guestId) {
                    gameState.selectedGuestId = null;
                } else {
                    gameState.selectedGuestId = guestId;
                }
                updateGuestUI();
                updateShowersUI();
            }

            function playSound(type) {
                let audio;
                if (type === 'success') {
                    audio = new Audio('https://cdn.freesound.org/previews/654/654321_12315704-lq.mp3');
                } else if (type === 'fail') {
                    audio = new Audio('https://cdn.freesound.org/previews/672/672085_14040168-lq.mp3');
                    audio.playbackRate = 0.7;
                }
                if (audio) audio.volume = 0.2, audio.play();
            }

            function callVolunteers() {
                if (gameState.score < CONFIG.VOLUNTEER_COST || gameState.volunteersActive) return;

                gameState.score -= CONFIG.VOLUNTEER_COST;
                gameState.volunteersActive = true;
                gameState.volunteerEndTime = Date.now() + CONFIG.VOLUNTEER_DURATION;

                gameState.showers.filter(s => s.status === 'dirty').forEach(shower => {
                    shower.status = 'cleaning';
                    shower.timer = startProgress(1000, p => shower.progress = p, () => {
                        shower.status = 'available';
                        updateShowersUI();
                    });
                });

                gameState.laundryMachines.forEach(machine => {
                    if (machine.status === 'washing' || machine.status === 'drying') {
                        clearInterval(machine.timer);
                        machine.status = 'ready';
                        machine.progress = 100;
                        updateLaundryMachinesUI();
                    }
                });

                gameState.suppliesToSort.forEach(supply => {
                    gameState.inventory[supply.type]++;
                });
                gameState.suppliesToSort = [];

                gameState.stress = Math.max(0, gameState.stress - 30);

                showVolunteerNotification();
                updateVolunteerButtonState();
                updateAllUI();

                setTimeout(() => {
                    gameState.volunteersActive = false;
                    gameState.volunteerEndTime = null;
                    updateVolunteerButtonState();
                }, CONFIG.VOLUNTEER_DURATION);
            }

            function showVolunteerNotification() {
                DOMElements.volunteerNotification.classList.remove('hidden');
                setTimeout(() => {
                    DOMElements.volunteerNotification.classList.add('hidden');
                }, 3000);
            }

            function updateVolunteerButtonState() {
                const canAfford = gameState.score >= CONFIG.VOLUNTEER_COST;
                const isActive = gameState.volunteersActive;

                DOMElements.volunteerCalloutBtn.disabled = !canAfford || isActive;

                if (isActive) {
                    DOMElements.volunteerCalloutBtn.textContent = 'Volunteers Helping...';
                    DOMElements.volunteerCalloutBtn.classList.add('btn-volunteer-active');
                } else if (!canAfford) {
                    DOMElements.volunteerCalloutBtn.textContent = `Need ${CONFIG.VOLUNTEER_COST}pts`;
                    DOMElements.volunteerCalloutBtn.classList.remove('btn-volunteer-active');
                } else {
                    DOMElements.volunteerCalloutBtn.textContent = `Call Volunteers (${CONFIG.VOLUNTEER_COST}pts)`;
                    DOMElements.volunteerCalloutBtn.classList.remove('btn-volunteer-active');
                }
            }

            function startGame() {
                initializeGameState();
                gameState.gameRunning = true;
                DOMElements.modalOverlay.classList.add('hidden');
                DOMElements.startModal.classList.add('hidden');
                DOMElements.gameOverModal.classList.add('hidden');
                leaderboardModal.classList.add('hidden');
                triggerDailyEvent();
                renderSupplyBins();
                updateAllUI();
                const difficulty = getDifficultySettings();
                gameState.timers.guestSpawner = setTimeout(spawnGuest, (Math.random() * difficulty.guestArrivalMax + difficulty.guestArrivalMin));
                gameState.timers.gameLoop = setInterval(gameLoop, 100);
                DOMElements.acceptSupplyDropBtn.disabled = false;
                updateVolunteerButtonState();
                if (typeof gtag === 'function') gtag('event', 'game_start');
            }

            function endGame(reason) {
                if (!gameState.gameRunning) return;
                gameState.gameRunning = false;
                clearInterval(gameState.timers.gameLoop);
                clearTimeout(gameState.timers.guestSpawner);
                gameState.timers.patience.forEach(timer => clearInterval(timer));

                DOMElements.finalScore.textContent = gameState.score;
                DOMElements.gameOverReason.textContent = reason;

                if (typeof gtag === 'function') gtag('event', 'game_over', {
                    reason: reason
                });

                if (gameState.score > 0) {
                    promptAndSubmitScore(gameState.score);
                } else {
                    DOMElements.leaderboardModal.classList.add('hidden');
                    DOMElements.startModal.classList.add('hidden');
                    DOMElements.gameOverModal.classList.remove('hidden');
                    DOMElements.modalOverlay.classList.remove('hidden');
                }
            }

            function gameLoop() {
                if (!gameState.gameRunning) return;
                let stressIncrease = gameState.guests.filter(g => g.status === 'waiting' || g.status === 'requesting' || g.status === 'laundry_waiting').length * 0.05 +
                    gameState.showers.filter(s => s.status === 'dirty').length * 0.1 +
                    gameState.suppliesToSort.length * 0.03;

                if (gameState.volunteersActive) {
                    stressIncrease *= 0.3;
                }

                gameState.stress = Math.min(CONFIG.MAX_STRESS, gameState.stress + stressIncrease);
                gameState.stress = Math.max(0, gameState.stress - 0.04);
                updateTopBarUI();
                if (gameState.stress >= CONFIG.MAX_STRESS) endGame("Your stress level got too high!");
                if (gameState.upsetGuests >= CONFIG.MAX_UPSET_GUESTS) endGame("Too many guests left upset!");
            }

            function triggerDailyEvent() {
                gameState.currentEvent = DAILY_EVENTS[Math.floor(Math.random() * DAILY_EVENTS.length)];
                DOMElements.dailyEventText.textContent = gameState.currentEvent.text;
            }

            function spawnGuest() {
                if (!gameState.gameRunning) return;

                const activeGuests = gameState.guests.filter(g => g.status === 'waiting' || g.status === 'showering' || g.status === 'laundry_waiting' || g.status === 'laundry_washing' || g.status === 'laundry_drying').length;
                if (activeGuests >= (CONFIG.NUM_SHOWER_STALLS + CONFIG.NUM_LAUNDRY_MACHINES + 2)) {
                    gameState.timers.guestSpawner = setTimeout(spawnGuest, 1500);
                    return;
                }

                const guestId = `guest-${gameState.nextIds.guest++}`;
                const isLaundry = Math.random() < 0.4;
                const guest = {
                    id: guestId,
                    status: isLaundry ? 'laundry_waiting' : 'waiting',
                    requests: [],
                    patience: 100,
                    mood: 'happy'
                };
                startPatienceTimer(guest);
                gameState.guests.push(guest);
                updateGuestUI(guestId);

                const difficulty = getDifficultySettings();
                const arrivalSpeed = (gameState.currentEvent.effect?.guestArrivalSpeed || 1);

                let spawnTimeMultiplier = 1.0;
                if (gameState.servicedGuestsCount >= 6) {
                    spawnTimeMultiplier = 1.3;
                }

                const spawnTime = (Math.random() * (difficulty.guestArrivalMax - difficulty.guestArrivalMin) + difficulty.guestArrivalMin) / arrivalSpeed * spawnTimeMultiplier;

                gameState.timers.guestSpawner = setTimeout(spawnGuest, spawnTime);
            }

            function startPatienceTimer(guest) {
                const difficulty = getDifficultySettings();
                const patienceInterval = setInterval(() => {
                    if (!gameState.gameRunning) { clearInterval(patienceInterval); return; }
                    const g = gameState.guests.find(g => g.id === guest.id);
                    if (!g) { clearInterval(patienceInterval); return; }
                    let patienceDrain = g.status === 'waiting' || g.status === 'laundry_waiting' ? 1 : 1.5;

                    if (gameState.volunteersActive) {
                        patienceDrain *= 0.5;
                    }

                    g.patience = Math.max(0, g.patience - patienceDrain);
                    if (g.patience <= 0) {
                        guestLeavesUpset(g.id);
                    } else {
                        const oldMood = g.mood;
                        if (g.patience < 40) g.mood = 'unhappy';
                        else if (g.patience < 75) g.mood = 'neutral';
                        if (oldMood !== g.mood) updateGuestUI(g.id);
                    }
                }, difficulty.guestPatience / 100 * (gameState.currentEvent.effect?.guestPatience || 1));
                guest.patienceTimer = patienceInterval;
                gameState.timers.patience.push(patienceInterval);
            }

            function guestLeavesUpset(guestId) {
                const guestIndex = gameState.guests.findIndex(g => g.id === guestId);
                if (guestIndex === -1) return;
                const guest = gameState.guests[guestIndex];
                clearInterval(guest.patienceTimer);
                gameState.guests.splice(guestIndex, 1);
                gameState.upsetGuests++;
                gameState.stress = Math.min(CONFIG.MAX_STRESS, gameState.stress + 15);
                updateGuestUI(guestId, true); updateTopBarUI();
                if (typeof gtag === 'function') gtag('event', 'guest_upset');
                if (gameState.upsetGuests >= CONFIG.MAX_UPSET_GUESTS) {
                    endGame("Too many guests left upset!");
                }
            }

            function assignGuestToShower(guestId, showerId) {
                const shower = gameState.showers.find(s => s.id === showerId);
                const guest = gameState.guests.find(g => g.id === guestId);
                if (!shower || shower.status !== 'available' || !guest || guest.status !== 'waiting') return;

                gameState.selectedGuestId = null;

                guest.status = 'showering';
                clearInterval(guest.patienceTimer);
                shower.status = 'occupied'; shower.guestId = guest.id;
                const difficulty = getDifficultySettings();
                const showerTime = difficulty.showerTime / (gameState.currentEvent.effect?.showerSpeed || 1);
                shower.timer = startProgress(showerTime, p => shower.progress = p, () => finishShowering(shower.id));
                updateGuestUI(guestId); updateShowersUI();
                playSound('success');
                if (typeof gtag === 'function') gtag('event', 'assign_guest_to_shower');
            }

            function finishShowering(showerId) {
                const shower = gameState.showers.find(s => s.id === showerId);
                if (!shower) return;
                const guest = gameState.guests.find(g => g.id === shower.guestId);
                shower.status = 'dirty';
                gameState.score += CONFIG.POINTS_PER_SHOWER;
                if (guest) {
                    guest.status = 'requesting';
                    generateGuestRequests(guest);
                    guest.patience = 100;
                    startPatienceTimer(guest);
                    updateGuestUI(guest.id);
                }
                updateShowersUI(); updateTopBarUI(); updateVolunteerButtonState();
            }

            function cleanShower(showerId) {
                const shower = gameState.showers.find(s => s.id === showerId);
                if (!shower || shower.status !== 'dirty') return;
                shower.status = 'cleaning';
                const difficulty = getDifficultySettings();
                let cleanTime = difficulty.cleanTime / (gameState.currentEvent.effect?.cleaningSpeed || 1);

                if (gameState.volunteersActive) {
                    cleanTime *= 0.3;
                }

                shower.timer = startProgress(cleanTime, p => shower.progress = p, () => {
                    shower.status = 'available'; updateShowersUI();
                });
                updateShowersUI();
                if (typeof gtag === 'function') gtag('event', 'clean_shower');
            }

            function acceptSupplyDrop() {
                DOMElements.acceptSupplyDropBtn.disabled = true;
                const supplyShortage = gameState.currentEvent.effect?.supplyShortage;
                const itemKeys = Object.keys(ITEM_TYPES);
                for (let i = 0; i < CONFIG.SUPPLY_DROP_SIZE; i++) {
                    let type = itemKeys[Math.floor(Math.random() * itemKeys.length)];
                    if (supplyShortage === type) continue;
                    gameState.suppliesToSort.push({ id: `supply-${gameState.nextIds.supply++}`, type });
                }
                updateSupplyDropUI();
                setTimeout(() => { if (gameState.gameRunning) DOMElements.acceptSupplyDropBtn.disabled = false; }, 3000);
            }

            function sortSupplyItem(supplyId, binType) {
                const supplyIndex = gameState.suppliesToSort.findIndex(s => s.id === supplyId);
                if (supplyIndex === -1) return;
                const item = gameState.suppliesToSort[supplyIndex];
                if (item.type === binType) {
                    gameState.inventory[item.type]++;
                    let points = 15;
                    gameState.score += points;
                    gameState.suppliesToSort.splice(supplyIndex, 1);
                    playSound('success');
                    if (typeof gtag === 'function') gtag('event', 'sort_supply', { result: 'correct', type: item.type });
                } else {
                    gameState.stress = Math.min(CONFIG.MAX_STRESS, gameState.stress + 5);
                    const binEl = DOMElements.supplyBins.querySelector(`.supply-bin[data-type="${binType}"]`);
                    binEl.classList.add('deny');
                    setTimeout(() => binEl.classList.remove('deny'), 400);
                    playSound('fail');
                    if (typeof gtag === 'function') gtag('event', 'sort_supply', { result: 'incorrect', type: item.type });
                }
                updateSupplyDropUI(); updateSupplyBinsUI(); updateTopBarUI(); updateVolunteerButtonState();
            }

            function generateGuestRequests(guest, onlySupplies) {
                const itemKeys = Object.keys(ITEM_TYPES).filter(k => k !== 'laundry');
                const difficulty = getDifficultySettings();
                const numRequests = Math.random() < difficulty.twoItemChance ? 2 : 1;
                if (!onlySupplies && Math.random() < 0.3) {
                    guest.requests.push({ type: 'laundry', fulfilled: false });
                }
                for (let i = 0; i < numRequests; i++) {
                    const type = itemKeys[Math.floor(Math.random() * itemKeys.length)];
                    if (!guest.requests.find(r => r.type === type)) {
                        guest.requests.push({ type, fulfilled: false });
                    }
                }
                if (guest.requests.length === 0) {
                    guest.requests.push({ type: itemKeys[Math.floor(Math.random() * itemKeys.length)], fulfilled: false });
                }
            }

            function fulfillRequest(guestId, itemType) {
                const guest = gameState.guests.find(g => g.id === guestId);
                const request = guest?.requests.find(r => r.type === itemType && !r.fulfilled);
                if (!request) return;
                if (gameState.inventory[itemType] > 0) {
                    gameState.inventory[itemType]--;
                    request.fulfilled = true;
                    let points = CONFIG.POINTS_PER_ITEM;
                    const itemBonus = gameState.currentEvent.effect?.itemBonus;
                    if (itemBonus && itemBonus.type === itemType) points += itemBonus.points;
                    gameState.score += points;
                    playSound('success');
                    if (guest.requests.every(r => r.fulfilled)) {
                        const guestIndex = gameState.guests.findIndex(g => g.id === guestId);
                        if (guestIndex > -1) {
                            clearInterval(guest.patienceTimer);
                            gameState.guests.splice(guestIndex, 1);
                            gameState.servicedGuestsCount++;
                            updateGuestUI(guestId, true);
                        }
                    } else {
                        updateGuestUI(guestId);
                    }
                    if (typeof gtag === 'function') gtag('event', 'fulfill_request', { item: itemType });
                } else {
                    const requestBubble = document.getElementById(guestId);
                    if (requestBubble) requestBubble.classList.add('deny');
                    setTimeout(() => requestBubble?.classList.remove('deny'), 400);
                    playSound('fail');
                }
                updateSupplyBinsUI(); updateTopBarUI(); updateVolunteerButtonState();
            }

            function startProgress(duration, onUpdate, onComplete) {
                let startTime = Date.now();
                const timer = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(100, (elapsed / duration) * 100);
                    if (onUpdate) onUpdate(progress);
                    if (progress >= 100) { clearInterval(timer); if (onComplete) onComplete(); }
                }, 100);
                return timer;
            }

            function handleDragStart(event, type, id) {
                gameState.dragged = { type, id, element: event.target };
                if (event.dataTransfer) event.dataTransfer.setData('text/plain', id);
                setTimeout(() => event.target.classList.add('dragging'), 0);
            }

            function handleDragEnd(event) {
                if (gameState.dragged.element) gameState.dragged.element.classList.remove('dragging');
                document.querySelectorAll('.droppable').forEach(el => el.classList.remove('droppable'));
                gameState.dragged = { type: null, id: null, element: null };
            }

            function handleDragOver(event) { event.preventDefault(); }

            function handleDragEnter(event, validDropType, isAvailable) {
                if (gameState.dragged.type === validDropType && isAvailable) event.currentTarget.classList.add('droppable');
            }

            function handleDragLeave(event) { event.currentTarget.classList.remove('droppable'); }

            function handleDrop(event, dropZoneType, dropZoneId) {
                event.preventDefault();
                event.currentTarget.classList.remove('droppable');
                if (gameState.dragged.type === 'guest' && dropZoneType === 'shower') assignGuestToShower(gameState.dragged.id, dropZoneId);
                else if (gameState.dragged.type === 'guest' && dropZoneType === 'laundry') assignGuestToLaundry(gameState.dragged.id, dropZoneId);
                else if (gameState.dragged.type === 'supply' && dropZoneType === 'bin') sortSupplyItem(gameState.dragged.id, dropZoneId);
            }

            function assignGuestToLaundry(guestId, machineId) {
                const machine = gameState.laundryMachines.find(m => m.id === machineId);
                const guest = gameState.guests.find(g => g.id === guestId);
                if (!machine || machine.status !== 'available' || !guest || guest.status !== 'laundry_waiting') return;
                gameState.selectedGuestId = null;
                guest.status = 'laundry_washing';
                clearInterval(guest.patienceTimer);
                machine.status = 'washing';
                machine.guestId = guest.id;
                const washTime = CONFIG.BASE_WASH_TIME;
                machine.timer = startProgress(washTime, p => { machine.progress = p; updateLaundryMachinesUI(); }, () => finishWashing(machine.id));
                updateGuestUI(guestId); updateLaundryMachinesUI(); playSound('success');
            }

            function finishWashing(machineId) {
                const machine = gameState.laundryMachines.find(m => m.id === machineId);
                if (!machine) return;
                machine.status = 'drying';
                machine.progress = 0;
                const dryTime = CONFIG.BASE_DRY_TIME;
                machine.timer = startProgress(dryTime, p => { machine.progress = p; updateLaundryMachinesUI(); }, () => {
                    machine.status = 'ready';
                    machine.progress = 100;
                    updateLaundryMachinesUI();
                });
                updateLaundryMachinesUI();
            }

            function finishLaundry(machineId) {
                const machine = gameState.laundryMachines.find(m => m.id === machineId);
                if (!machine) return;
                const guest = gameState.guests.find(g => g.id === machine.guestId);
                machine.status = 'available';
                machine.guestId = null;
                machine.progress = 0;
                if (guest) {
                    gameState.score += CONFIG.POINTS_PER_SHOWER;
                    guest.status = 'requesting';
                    generateGuestRequests(guest, true);
                    guest.patience = 100;
                    startPatienceTimer(guest);
                    updateGuestUI(guest.id);
                }
                updateLaundryMachinesUI(); updateTopBarUI(); updateVolunteerButtonState();
            }

            function updateAllUI() {
                updateTopBarUI();
                updateGuestUI();
                updateShowersUI();
                updateLaundryMachinesUI();
                updateSupplyDropUI();
                updateSupplyBinsUI();
                updateVolunteerButtonState();
            }

            function updateGuestUI(guestIdToUpdate, remove = false) {
                if (guestIdToUpdate) {
                    const element = document.getElementById(guestIdToUpdate);
                    if (remove) {
                        element?.remove();
                        return;
                    }
                }

                DOMElements.guestQueue.innerHTML = '';
                DOMElements.requestsArea.innerHTML = '';

                const laundryQueueDiv = document.createElement('div');
                laundryQueueDiv.id = 'laundry-queue';
                laundryQueueDiv.className = 'space-y-2 mb-4';

                const showerQueueDiv = document.createElement('div');
                showerQueueDiv.id = 'shower-queue';
                showerQueueDiv.className = 'space-y-2 mb-4';

                gameState.guests.forEach(guest => {
                    const isSelected = guest.id === gameState.selectedGuestId;
                    const moodEmoji = { happy: 'üòä', neutral: 'üòê', unhappy: 'üò†' }[guest.mood];
                    let newHTML = '', parentEl = null, className = 'p-2 rounded-lg border-2 bg-white';
                    if (isSelected) className += ' selected';

                    if (guest.status === 'waiting') {
                        parentEl = showerQueueDiv;
                        className += ' guest';
                        newHTML = `<div class="flex justify-between items-center pointer-events-none"><span class="font-bold">${moodEmoji} Guest #${guest.id.split('-')[1]}</span></div>
                                <div class="progress-bar mt-2 h-1.5"><div class="progress-bar-fill bg-green-500" style="width: ${guest.patience}%;"></div></div>`;
                    } else if (guest.status === 'laundry_waiting') {
                        parentEl = laundryQueueDiv;
                        className += ' guest';
                        newHTML = `<div class="flex justify-between items-center pointer-events-none"><span class="font-bold">${moodEmoji} Guest #${guest.id.split('-')[1]}</span><span class="text-2xl">üß∫</span></div>
                                <div class="progress-bar mt-2 h-1.5"><div class="progress-bar-fill bg-blue-400" style="width: ${guest.patience}%;"></div></div>`;
                    } else if (guest.status === 'requesting') {
                        parentEl = DOMElements.requestsArea;
                        className += ' item-request-bubble';
                        const requestIcons = guest.requests.map(r => `<span data-type="${r.type}" class="requested-item text-2xl ${r.fulfilled ? 'fulfilled' : ''}">${ITEM_TYPES[r.type].emoji}</span>`).join('');
                        newHTML = `<div class="flex items-center justify-between">
                                    <span class="font-bold pointer-events-none">${moodEmoji} Guest #${guest.id.split('-')[1]}</span>
                                    <div class="flex gap-2">${requestIcons}</div>
                                </div>
                                <div class="progress-bar mt-2 h-1.5"><div class="progress-bar-fill bg-orange-400" style="width: ${guest.patience}%;"></div></div>`;
                    }

                    if (parentEl) {
                        const element = document.createElement('div');
                        element.id = guest.id;
                        element.className = className;
                        element.innerHTML = newHTML;
                        if (guest.status === 'waiting' || guest.status === 'laundry_waiting') {
                            element.draggable = true;
                            element.addEventListener('dragstart', e => handleDragStart(e, 'guest', guest.id));
                            element.addEventListener('dragend', handleDragEnd);
                        }
                        parentEl.appendChild(element);
                    }
                });

                DOMElements.guestQueue.appendChild(showerQueueDiv);
                DOMElements.guestQueue.appendChild(laundryQueueDiv);
            }

            function updateTopBarUI() {
                DOMElements.score.textContent = gameState.score; DOMElements.day.textContent = gameState.day;
                DOMElements.stressBar.style.width = `${gameState.stress}%`;
                DOMElements.stressBar.style.backgroundColor = gameState.stress > 75 ? '#dc2626' : (gameState.stress > 40 ? '#f59e0b' : '#22c55e');
                DOMElements.upsetGuests.textContent = `${gameState.upsetGuests}/${CONFIG.MAX_UPSET_GUESTS}`;
            }

            function updateShowersUI() {
                DOMElements.showerStallsArea.innerHTML = '';
                const isGuestSelected = gameState.selectedGuestId !== null;
                gameState.showers.forEach(shower => {
                    const showerDiv = document.createElement('div');
                    showerDiv.id = shower.id;
                    let content = '', classes = 'p-2 rounded-lg border-2 text-center transition-all flex flex-col justify-center items-center min-h-[120px]';
                    switch (shower.status) {
                        case 'available':
                            classes += ' shower-stall bg-blue-50 border-blue-200';
                            if (isGuestSelected) classes += ' tap-target';
                            content = `<span class="text-4xl pointer-events-none">üöø</span><span class="font-bold text-green-700 pointer-events-none">Available</span>`;
                            showerDiv.addEventListener('dragover', handleDragOver);
                            showerDiv.addEventListener('dragenter', e => handleDragEnter(e, 'guest', true));
                            showerDiv.addEventListener('dragleave', handleDragLeave);
                            showerDiv.addEventListener('drop', e => handleDrop(e, 'shower', shower.id));
                            break;
                        case 'occupied': classes += ' bg-yellow-50 border-yellow-200'; content = `<span class="text-4xl pointer-events-none">üõÄ</span><span class="font-bold text-yellow-700 pointer-events-none">Occupied</span><div class="progress-bar h-2 mt-2"><div class="progress-bar-fill bg-yellow-500" style="width: ${shower.progress}%;"></div></div>`; break;
                        case 'dirty': classes += ' shower-stall dirty bg-red-50 border-red-200'; content = `<span class="text-4xl pointer-events-none">üßπ</span><span class="font-bold text-red-700 pointer-events-none">Click to Clean</span>`; break;
                        case 'cleaning': classes += ' bg-indigo-50 border-indigo-200'; content = `<span class="text-4xl pointer-events-none">‚ú®</span><span class="font-bold text-indigo-700 pointer-events-none">Cleaning</span><div class="progress-bar h-2 mt-2"><div class="progress-bar-fill bg-indigo-500" style="width: ${shower.progress}%;"></div></div>`; break;
                    }
                    showerDiv.className = classes;
                    showerDiv.innerHTML = content;
                    DOMElements.showerStallsArea.appendChild(showerDiv);
                });
            }

            function updateLaundryMachinesUI() {
                const area = document.getElementById('laundry-machines-area');
                area.innerHTML = '';
                gameState.laundryMachines.forEach(machine => {
                    const div = document.createElement('div');
                    div.id = machine.id;
                    let content = '', classes = 'laundry-machine text-center';
                    switch (machine.status) {
                        case 'available':
                            classes += ' available';
                            content = `<span class="machine-icon">üß∫</span><span class="machine-status">Available</span>`;
                            div.addEventListener('dragover', handleDragOver);
                            div.addEventListener('dragenter', e => handleDragEnter(e, 'guest', true));
                            div.addEventListener('dragleave', handleDragLeave);
                            div.addEventListener('drop', e => handleDrop(e, 'laundry', machine.id));
                            break;
                        case 'washing':
                            classes += ' washing';
                            content = `<span class="machine-icon">üßº</span><span class="machine-status">Washing</span><div class="progress-bar h-2 mt-2"><div class="progress-bar-fill bg-blue-500" style="width: ${machine.progress}%;"></div></div>`;
                            break;
                        case 'drying':
                            classes += ' drying';
                            content = `<span class="machine-icon">üí®</span><span class="machine-status">Drying</span><div class="progress-bar h-2 mt-2"><div class="progress-bar-fill bg-yellow-400" style="width: ${machine.progress}%;"></div></div>`;
                            break;
                        case 'ready':
                            classes += ' ready';
                            content = `<span class="machine-icon">‚úÖ</span><span class="machine-status">Ready</span>`;
                            div.addEventListener('click', () => finishLaundry(machine.id));
                            break;
                    }
                    div.className = classes;
                    div.innerHTML = content;
                    area.appendChild(div);
                });
            }

            function updateSupplyDropUI() {
                DOMElements.supplyDropArea.innerHTML = gameState.suppliesToSort.map(s => `<div id="${s.id}" draggable="true" data-type="${s.type}" class="supply-item">${ITEM_TYPES[s.type].emoji}</div>`).join('');
                DOMElements.supplyDropArea.querySelectorAll('.supply-item').forEach(el => {
                    el.addEventListener('dragstart', e => handleDragStart(e, 'supply', el.id));
                    el.addEventListener('dragend', handleDragEnd);
                });
            }

            function renderSupplyBins() {
                DOMElements.supplyBins.innerHTML = Object.keys(ITEM_TYPES).map(type => `
                <div class="supply-bin p-2 rounded-lg border-2 text-center transition-all" data-type="${type}">
                    <span class="text-2xl">${ITEM_TYPES[type].emoji}</span><h3 class="text-xs font-bold">${ITEM_TYPES[type].name}</h3><p id="${type}-stock" class="text-lg font-bold">0</p>
                </div>`).join('');
                DOMElements.supplyBins.querySelectorAll('.supply-bin').forEach(bin => {
                    bin.addEventListener('dragover', handleDragOver);
                    bin.addEventListener('dragenter', e => handleDragEnter(e, 'supply', true));
                    bin.addEventListener('dragleave', handleDragLeave);
                    bin.addEventListener('drop', e => handleDrop(e, 'bin', bin.dataset.type));
                });
            }

            function updateSupplyBinsUI() {
                Object.keys(ITEM_TYPES).forEach(type => {
                    const stockEl = document.getElementById(`${type}-stock`);
                    if (stockEl) stockEl.textContent = gameState.inventory[type];
                });
            }

            function addTouchDnD() {
                let draggedElement = null;
                document.body.addEventListener('touchstart', function (e) {
                    const targetEl = e.target.closest('.supply-item');
                    if (!targetEl) return;
                    draggedElement = { element: targetEl, type: 'supply', id: targetEl.id };
                    targetEl.classList.add('dragging');
                    e.preventDefault();
                }, { passive: false });
                document.body.addEventListener('touchmove', function (e) {
                    if (!draggedElement) return;
                    e.preventDefault();
                    let touch = e.touches[0];
                    let dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
                    document.querySelectorAll('.droppable').forEach(el => el.classList.remove('droppable'));
                    if (!dropTarget) return;
                    const supplyBin = dropTarget.closest('.supply-bin');
                    if (supplyBin) {
                        supplyBin.classList.add('droppable');
                    }
                }, { passive: false });
                    let dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
                    document.querySelectorAll('.droppable').forEach(el => el.classList.remove('droppable'));
                    if (!dropTarget) return;
                    const supplyBin = dropTarget.closest('.supply-bin');
                    if (supplyBin) {
                        supplyBin.classList.add('droppable');
                    }
                }, { passive: false });
                document.body.addEventListener('touchend', function (e) {
                    if (!draggedElement) return;
                    e.preventDefault();
                    draggedElement.element.classList.remove('dragging');
                    let touch = e.changedTouches[0];
                    let dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
                    document.querySelectorAll('.droppable').forEach(el => el.classList.remove('droppable'));
                    if (dropTarget) {
                        const supplyBin = dropTarget.closest('.supply-bin');
                        if (supplyBin) sortSupplyItem(draggedElement.id, supplyBin.dataset.type);
                    }
                    draggedElement = null;
                }, { passive: false });
            }

            DOMElements.startGameBtn.addEventListener('click', startGame);
            DOMElements.restartGameBtn.addEventListener('click', startGame);
            DOMElements.acceptSupplyDropBtn.addEventListener('click', acceptSupplyDrop);
            DOMElements.volunteerCalloutBtn.addEventListener('click', callVolunteers);

            DOMElements.guestQueue.addEventListener('click', e => {
                const targetGuest = e.target.closest('.guest');
                if (targetGuest) {
                    selectGuest(targetGuest.id);
                }
            });

            DOMElements.showerStallsArea.addEventListener('click', e => {
                const target = e.target.closest('.shower-stall');
                if (!target) return;

                if (target.classList.contains('dirty')) {
                    cleanShower(target.id);
                } else if (target.classList.contains('tap-target') && gameState.selectedGuestId) {
                    assignGuestToShower(gameState.selectedGuestId, target.id);
                }
            });

            DOMElements.gameContainer.addEventListener('click', e => {
                if (e.target.closest('.station') && !e.target.closest('.guest, .shower-stall, .item-request-bubble') && gameState.selectedGuestId) {
                    selectGuest(gameState.selectedGuestId);
                }
            });

            DOMElements.requestsArea.addEventListener('click', e => {
                const targetItem = e.target.closest('.requested-item');
                const targetGuest = e.target.closest('.item-request-bubble');
                if (targetItem && targetGuest && !targetItem.classList.contains('fulfilled')) {
                    fulfillRequest(targetGuest.id, targetItem.dataset.type);
                }
            });

            DOMElements.modalOverlay.classList.remove('hidden');
            DOMElements.startModal.classList.remove('hidden');

            initializeGameState();
            addTouchDnD();
        });
    </script>
</body>

</html>
